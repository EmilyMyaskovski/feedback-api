<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Feedback Analytics</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .header-bg { background-color: #3f51b5; color: white; padding: 40px 0; margin-bottom: 30px; }
    h1, h2, h3, h4 { font-weight: 700; }

    /* Design for the filter fields in the table */
    .filter-input {
        width: 100%;
        padding: 4px 8px;
        font-size: 13px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .filter-row th {
        background-color: #f8f9fa;
        padding: 5px;
    }

    /* Style for the empty state of the side chart */
    .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        text-align: center;
        flex-direction: column;
    }
  </style>
</head>

<body>
  <div class="header-bg text-center">
    <h1>üìä Smart Feedback Portal</h1>
    <p>Real-time User Insights & Data</p>
  </div>

  <div class="container-fluid px-4">
    
    <div class="row">
        <div class="col-lg-8">
            <div class="chart-card" style="height: 550px;">
              <h2 class="text-center mb-4">üåç Global Satisfaction Map</h2>
              <div id="regions_div" style="width: 100%; height: 450px;"></div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="chart-card" style="height: 550px;">
                <h4 class="text-center mb-3" id="countryChartTitle">Select a Country</h4>
                <div style="height: 400px; position: relative;">
                    <canvas id="countryChart"></canvas>
                    <div id="countryEmptyState" class="empty-state">
                        <div style="font-size: 3rem;">üëÜ</div>
                        <p>Click on a country on the map<br>to see specific rating breakdown.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <div class="chart-card">
        <h2 class="text-center mb-4">üë• Audience Demographics (Est.)</h2>
        <div style="width: 100%; max-width: 800px; margin: 0 auto;">
            <canvas id="demographicsChart"></canvas>
        </div>
        </div>

        <div class="chart-card">
        <h4 class="mb-3">üìù Recent User Reports</h4>
        <table class="table table-hover table-striped">
            <thead>
            <tr>
                <th>ID</th>
                <th>Feature</th>
                <th>Rating</th>
                <th>Feedback</th>
                <th>Device</th>
                <th>Screenshot</th>
            </tr>
            <tr class="filter-row">
                <th><input type="text" id="searchId" class="filter-input" placeholder="Search ID..." onkeyup="applyFilters()"></th>
                <th><input type="text" id="searchFeature" class="filter-input" placeholder="Filter Feature..." onkeyup="applyFilters()"></th>
                <th>
                    <select id="searchRating" class="filter-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê</option>
                        <option value="2">‚≠ê‚≠ê</option>
                        <option value="1">‚≠ê</option>
                    </select>
                </th>
                <th><input type="text" id="searchText" class="filter-input" placeholder="Search text..." onkeyup="applyFilters()"></th>
                <th><input type="text" id="searchDevice" class="filter-input" placeholder="Filter Device..." onkeyup="applyFilters()"></th>
                <th></th> 
            </tr>
            </thead>
            <tbody id="feedbackTableBody"></tbody>
        </table>
        </div>
    </div>
  </div>

  <script>
    let demographicsChartInstance = null;
    let countryChartInstance = null; // New instance for side chart
    let allFeedbackData = [];

    // Load Google Charts safely
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load: ' + src));
        document.head.appendChild(s);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Always load data/table/chart. Map draws only if Google loads.
      let canDrawMap = true;

      try {
        if (!window.google) {
          await loadScript('https://www.gstatic.com/charts/loader.js');
        }
        google.charts.load('current', { packages: ['geochart'] });
        google.charts.setOnLoadCallback(() => initDashboard(true));
      } catch (e) {
        console.error('Google Charts failed (map disabled):', e);
        canDrawMap = false;
        initDashboard(false);
      }
    });

    function initDashboard(canDrawMap) {
      fetchDataFromAPI(canDrawMap);
    }

    function fetchDataFromAPI(canDrawMap) {
      fetch('/api/feedback')
        .then(r => r.json())
        .then(data => {
          allFeedbackData = data.slice().reverse();
          if (canDrawMap) {
            try { drawMap(data); } catch (e) { console.error('Map error:', e); }
          } else {
            const el = document.getElementById('regions_div');
            if (el) el.innerHTML = '<div class="text-muted">Map unavailable (Google Charts blocked).</div>';
          }

          renderTable(allFeedbackData);
          drawDemographicsFromFeedback(data); // graph from app runs
        })
        .catch(err => console.error('Error fetching data:', err));
    }

    // ---------- FILTER LOGIC ----------
    function applyFilters() {
        const idTerm = document.getElementById('searchId').value.toLowerCase();
        const featureTerm = document.getElementById('searchFeature').value.toLowerCase();
        const ratingTerm = document.getElementById('searchRating').value;
        const textTerm = document.getElementById('searchText').value.toLowerCase();
        const deviceTerm = document.getElementById('searchDevice').value.toLowerCase();

        const filteredData = allFeedbackData.filter(item => {
            const matchesId = (item.id || '').toString().toLowerCase().includes(idTerm);
            const matchesFeature = (item.featureTag || '').toLowerCase().includes(featureTerm);
            const matchesText = (item.userText || '').toLowerCase().includes(textTerm);
            const matchesDevice = ((item.deviceModel || '') + ' ' + (item.osVersion || '')).toLowerCase().includes(deviceTerm);
            const matchesRating = ratingTerm === "" || (item.rating || 0).toString() === ratingTerm;

            return matchesId && matchesFeature && matchesRating && matchesText && matchesDevice;
        });

        renderTable(filteredData);
    }

    // ---------- MAP + INTERACTION ----------
    function drawMap(rawData) {
      if (!window.google || !google.visualization) return;

      const countryStats = {};
      rawData.forEach(r => {
        const country = r.country || "Unknown";
        const rating = Number(r.rating) || 0;
        if (!countryStats[country]) countryStats[country] = { sum: 0, count: 0 };
        countryStats[country].sum += rating;
        countryStats[country].count += 1;
      });

      const mapData = [['Country', 'Average Rating']];
      for (const [code, stats] of Object.entries(countryStats)) {
        if (code !== "Unknown" && stats.count > 0) mapData.push([code, stats.sum / stats.count]);
      }

      const el = document.getElementById('regions_div');
      if (!el) return;

      if (mapData.length === 1) {
        el.innerHTML = '<div class="text-muted text-center pt-5">No country data yet.</div>';
        return;
      }

      const dataTable = google.visualization.arrayToDataTable(mapData);
      const options = {
        colorAxis: { minValue: 1, maxValue: 5, colors: ['#e74c3c', '#f1c40f', '#2ecc71'] },
        backgroundColor: '#ffffff',
        datalessRegionColor: '#eeeeee',
        defaultColor: '#f5f5f5',
        legend: 'none' // Cleaner look since we have the side chart
      };

      const chart = new google.visualization.GeoChart(el);

      // --- ADDED: Listener for clicks on countries ---
      google.visualization.events.addListener(chart, 'select', function() {
          const selection = chart.getSelection();
          if (selection.length > 0) {
              const row = selection[0].row;
              // Get country name from column 0
              const countryCode = dataTable.getValue(row, 0);
              showCountryDetails(countryCode);
          }
      });

      chart.draw(dataTable, options);
    }

    // ---------- NEW: COUNTRY SIDE CHART LOGIC ----------
    function showCountryDetails(countryCode) {
        // 1. Hide empty state, show title
        document.getElementById('countryEmptyState').style.display = 'none';
        document.getElementById('countryChartTitle').innerText = 'Ratings in: ' + countryCode;

        // 2. Filter data for selected country
        const countryReports = allFeedbackData.filter(r => r.country === countryCode);
        
        // 3. Count stars (1-5)
        const counts = [0, 0, 0, 0, 0];
        countryReports.forEach(r => {
            const rating = Number(r.rating) || 0;
            if (rating >= 1 && rating <= 5) {
                counts[rating - 1]++;
            }
        });

        // 4. Draw Chart using Chart.js
        const ctx = document.getElementById('countryChart').getContext('2d');
        
        if (countryChartInstance) countryChartInstance.destroy();

        countryChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1‚≠ê', '2‚≠ê', '3‚≠ê', '4‚≠ê', '5‚≠ê'],
                datasets: [{
                    label: 'Count',
                    data: counts,
                    backgroundColor: [
                        '#e74c3c', // Red
                        '#e67e22', // Orange
                        '#f1c40f', // Yellow
                        '#2ecc71', // Light Green
                        '#27ae60'  // Dark Green
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { stepSize: 1 } 
                    }
                }
            }
        });
    }

    // ---------- TABLE ----------
    function renderTable(data) {
      const tableBody = document.getElementById('feedbackTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = "";
      
      if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3 text-muted">No matching records found</td></tr>';
          return;
      }

      const limit = 50;
      const displayData = data.slice(0, limit);
      
      displayData.forEach(report => {
        const stars = '‚≠ê'.repeat(Number(report.rating) || 0);

        let imageHtml = '<span class="text-muted">-</span>';
        if (report.screenshotBase64) {
          const s = String(report.screenshotBase64);
          const src = s.startsWith('data:image') ? s : `data:image/jpeg;base64,${s}`;
          imageHtml = `<img src="${src}" height="40" style="cursor:pointer; border:1px solid #ccc; border-radius:4px;" onclick="window.open(this.src)">`;
        }

        const idStr = (report.id ?? '').toString();

        tableBody.innerHTML += `
          <tr>
            <td><small title="${idStr}">${idStr.substring(0, 8)}...</small></td>
            <td><span class="badge bg-primary">${escapeHtml(report.featureTag ?? '-')}</span></td>
            <td>${stars}</td>
            <td>${escapeHtml(report.userText ?? '')}</td>
            <td style="font-size: 0.85em; color: gray;">
              <b>${escapeHtml(report.deviceModel ?? '-')}</b><br>${escapeHtml(report.osVersion ?? '-')}
            </td>
            <td>${imageHtml}</td>
          </tr>
        `;
      });
      
      if (data.length > limit) {
          tableBody.innerHTML += `<tr><td colspan="6" class="text-center text-muted"><small>Showing first ${limit} results out of ${data.length}...</small></td></tr>`;
      }
    }

    // ---------- DEMOGRAPHICS GRAPH ----------
    function drawDemographicsFromFeedback(reports) {
      if (!window.Chart) return;

      const canvas = document.getElementById('demographicsChart');
      if (!canvas) return;

      const labels = ['15-24', '25-34', '35-44', '45-54', '55-64', '+64'];
      const male = [0,0,0,0,0,0];
      const female = [0,0,0,0,0,0];
      
      const bucketIndex = (age) => {
        const a = Number(age);
        if (!Number.isFinite(a) || a < 15) return -1;
        if (a <= 24) return 0;
        if (a <= 34) return 1;
        if (a <= 44) return 2;
        if (a <= 54) return 3;
        if (a <= 64) return 4;
        return 5;
      };

      let used = 0;
      reports.forEach(r => {
        const idx = bucketIndex(r.userAge); 
        const g = (r.userGender ?? '').toString().trim().toLowerCase(); 
        
        if (idx === -1 || !g) return;

        used++;
        if (g === 'male' || g === 'm' || g === '◊ñ◊õ◊®') male[idx]++;
        else if (g === 'female' || g === 'f' || g === '◊†◊ß◊ë◊î') female[idx]++;
      });

      if (demographicsChartInstance) demographicsChartInstance.destroy();

      if (used === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "16px Segoe UI";
        ctx.fillStyle = "#666";
        ctx.textAlign = "center";
        ctx.fillText("No demographics data yet.", canvas.width/2, 50);
        ctx.fillText("Send feedback with age & gender from the app.", canvas.width/2, 80);
        return;
      }

      demographicsChartInstance = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { 
                label: 'Male', 
                data: male.map(x => -x), // Negative values for left side
                backgroundColor: '#3F51B5', // Blue matching Android
                borderRadius: 4
            },    
            { 
                label: 'Female', 
                data: female,
                backgroundColor: '#4CAF50', // Green matching Android
                borderRadius: 4
            } 
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: { stacked: true, ticks: { callback: v => Math.abs(v) } },
            y: { stacked: true }
          },
          plugins: {
            tooltip: { 
                callbacks: { 
                    label: c => `${c.dataset.label}: ${Math.abs(c.raw)}` 
                } 
            }
          }
        }
      });
    }

    function escapeHtml(str) {
      return (str ?? '').toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
  </script>
</body>
</html>