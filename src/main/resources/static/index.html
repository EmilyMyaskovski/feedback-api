<script>
    let demographicsChartInstance = null;

    // Load Google charts FIRST, then init
    google.charts.load('current', { packages: ['geochart'] });
    google.charts.setOnLoadCallback(initDashboard);

    function initDashboard() {
        fetchDataFromAPI();
    }

    function fetchDataFromAPI() {
        fetch('/api/feedback')
            .then(r => r.json())
            .then(data => {
                drawMap(data);
                renderTable(data);
                drawDemographicsFromFeedback(data); // ✅ chart from app data
            })
            .catch(err => console.error('API error:', err));
    }

    // ---------- MAP ----------
    function drawMap(rawData) {
        const countryStats = {};
        rawData.forEach(r => {
            const country = r.country || "Unknown";
            const rating = Number(r.rating) || 0;

            if (!countryStats[country]) countryStats[country] = { sum: 0, count: 0 };
            countryStats[country].sum += rating;
            countryStats[country].count += 1;
        });

        const mapData = [['Country', 'Average Rating']];
        for (const [code, stats] of Object.entries(countryStats)) {
            if (code !== "Unknown" && stats.count > 0) {
                mapData.push([code, stats.sum / stats.count]);
            }
        }

        if (mapData.length === 1) return;

        const dataTable = google.visualization.arrayToDataTable(mapData);
        const options = {
            colorAxis: { minValue: 1, maxValue: 5, colors: ['#e74c3c', '#f1c40f', '#2ecc71'] },
            backgroundColor: '#ffffff',
            datalessRegionColor: '#eeeeee',
            defaultColor: '#f5f5f5',
        };

        const el = document.getElementById('regions_div');
        if (!el) return;

        const chart = new google.visualization.GeoChart(el);
        chart.draw(dataTable, options);
    }

    // ---------- TABLE ----------
    function renderTable(data) {
        const tableBody = document.getElementById('feedbackTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = "";
        const recentData = data.slice().reverse().slice(0, 10);

        recentData.forEach(report => {
            const stars = '⭐'.repeat(Number(report.rating) || 0);

            let imageHtml = '<span class="text-muted">-</span>';
            if (report.screenshotBase64) {
                const s = String(report.screenshotBase64);
                const src = s.startsWith('data:image') ? s : `data:image/jpeg;base64,${s}`;
                imageHtml = `<img src="${src}" height="50" style="cursor:pointer; border:1px solid #ccc; border-radius:4px;" onclick="window.open(this.src)">`;
            }

            const idStr = (report.id ?? '').toString();

            const row = `
              <tr>
                <td><small>${idStr.substring(0, 8)}...</small></td>
                <td><span class="badge bg-primary">${escapeHtml(report.featureTag ?? '-')}</span></td>
                <td>${stars}</td>
                <td>${escapeHtml(report.userText ?? '')}</td>
                <td style="font-size: 0.85em; color: gray;">
                  <b>${escapeHtml(report.deviceModel ?? '-')}</b><br>${escapeHtml(report.osVersion ?? '-')}
                </td>
                <td>${imageHtml}</td>
              </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // ---------- DEMOGRAPHICS GRAPH (FROM APP RUNS) ----------
    function drawDemographicsFromFeedback(reports) {
        if (!window.Chart) return;

        const canvas = document.getElementById('demographicsChart');
        if (!canvas) return;

        const labels = ['15-24', '25-34', '35-44', '45-54', '55-64', '+64'];
        const male = [0,0,0,0,0,0];
        const female = [0,0,0,0,0,0];
        const other = [0,0,0,0,0,0];

        const bucketIndex = (age) => {
            const a = Number(age);
            if (!Number.isFinite(a) || a < 15) return -1;
            if (a <= 24) return 0;
            if (a <= 34) return 1;
            if (a <= 44) return 2;
            if (a <= 54) return 3;
            if (a <= 64) return 4;
            return 5;
        };

        let used = 0;

        reports.forEach(r => {
            const idx = bucketIndex(r.age);
            const g = (r.gender ?? '').toString().trim().toLowerCase();
            if (idx === -1 || !g) return;

            used++;
            if (g === 'male' || g === 'm') male[idx]++;
            else if (g === 'female' || g === 'f') female[idx]++;
            else other[idx]++;
        });

        if (demographicsChartInstance) demographicsChartInstance.destroy();

        if (used === 0) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "16px Segoe UI";
            ctx.fillStyle = "#666";
            ctx.fillText("No demographics yet (send age + gender from app).", 10, 30);
            return;
        }

        demographicsChartInstance = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Male', data: male.map(x => -x) },
                    { label: 'Female', data: female },
                    { label: 'Other/Unknown', data: other, hidden: true }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: { callback: v => Math.abs(v) }},
                    y: { stacked: true }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: c => `${c.dataset.label}: ${Math.abs(c.raw)}`
                        }
                    }
                }
            }
        });
    }

    function escapeHtml(str) {
        return (str ?? '').toString()
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
    }
</script>
